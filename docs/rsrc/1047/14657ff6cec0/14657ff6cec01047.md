Rasberry pi 5 に対する初期セットアップ手順をまとめます

# OS

Ubuntu 24.04 を Rasberry Pi Imager にて microSD に書き込み、本体に挿入して起動

初回ログイン時にパスワードの変更を求められるが、この段階では、日本語キーボードで記号を含むパスワードを入力しないほうがいい

# キーボードレイアウト変更

```sh
sudo dpkg-reconfigure keyboard-configuration
```

Generic 105-key PC

Japanese

Japanese

The default for the keyboard layout

No compose key

しばらく待ちます

reboot しときます

# パスワード変更

キーボードレイアウト変えたのでパスワード変えます。記号入れたパスワードにします

```sh
passwd
```

今のパスワード、そして新しいパスワード二回打ちます、完了

> [!NOTE]
> と思ったが、のちのち新しくアカウント作るので変えなくてもよかったかも

# Internet port の名前を udev で固定

## MAC address 確認

```sh
ip a
```
目的のクチ（eth0 とか) の MAC Address を控える

## udev rule 書く

10-network.rules を作り

```text
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="XX:XX:XX:XX:XX:XX", NAME="foobar"
```

foobar は特定の名前で

あとはすでにある `70-snap.snapd.rules` を一旦リネームして無効に

(リロードする方法がありそうですが) reboot する

再度 `ip a` などすると、 `eth0` などの名前から `foobar` に代わっていることがわかります

# netplan で IP 固定

あらかじめ指定した IP アドレスを振っておきます

`192.168.100.150` を振るとします

## config ファイル書く

`/etc/netplan/01-config.yaml` にファイルを作り

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    foobar:
      dhcp4: false
      addresses:
        - 192.168.100.150/24
      routes:
        - to: default
          via: 192.168.100.1
```
を書いて保存。 （foobar は先ほどの udev 名に）

## chmod する

```sh
sudo chmod 600 /etc/netplan/01-config.yaml
```

## いらないのを消す

もとから `50-cloud-init.yaml` が置いてあるので、リネームして無効にする

## try reload する

```sh
sudo netplan try
```

エラーがあったら怒られます

問題なければ Enter を押せと来るので、 Enter 押す

## 確認

例によって `ip a` などで確認

なんか変わらなかったので reboot したら変わった

# 新しいユーザー作る

ユーザー名は初期 `ubuntu` で作られるが、管理者ユーザー名を変えたいので、新しくユーザーを作り変える

## 参考

https://qiita.com/white_aspara25/items/c1b9d02310b4731bfbaa

新しくユーザー `neko` を作る

```sh
sudo adduser neko
```

パスワード二回入れて、あとは Enter でデフォルト指定して、最後 `Y` で終わり

```sh
sudo gpasswd -a neko sudo
> Adding user neko to group sudo
```

## 作ったユーザーで再ログイン

```sh
logout
```

作ったユーザーでログイン

## `ubuntu` ユーザ消す

とにかく全部消してよいので

```sh
sudo userdel -r ubuntu
```

```sh
ip ubuntu
> id: 'ubuntu': no such user
```

削除できた

# ssh の設定と鍵の設定

ssh はデフォルトで起動済み

## 一旦パスワードを使って接続を試す

別の (メイン) PC (windows) から

```cmd
ssh neko@192.168.100.150
```

パスワードが聞かれるが Permission denied (public key) になる

## `sshd_config` を編集する

`/etc/ssh/sshd_config` を編集し

`PasswordAuthentication yes` のコメントアウトを外し

`KbdInteractiveAuthentication yes` に変更

保存して ssh リスタート

```sh
sudo systemctl restart ssh
```

メイン PC からもう一度試すと、パスワード聞かれて入力、無事ログインできた

## メイン PC で鍵作成

自分はすでに別の用途で鍵をいくつか用意していますが、このサーバー用にもうひとつ用意します。

`ssh-keygen` で鍵を作成します。今はデフォルトで ed25519 が使われるんですね。鍵の作り方はいろいろ流儀があるので調べてみてください

## 公開鍵をサーバーに登録

ssh 接続しているサーバー側に戻り

```sh
mkdir ~/.ssh
nano ~/.ssh/authorized_keys
```

先ほどメイン PC で作った鍵の公開鍵 (たいてい C:/users/NAME/.ssh/id_ed25519.pub など) の中身をコピーして、 サーバー側へ貼り付けます

```text
ssh-ed25519 ABCDEFG....XYZ neko@nekoneko-pc
```

## 鍵でログインを試す

`exit` で一旦 ssh セッションを抜けて、再度ログイン

その際、先ほどの鍵の秘密鍵パスを指定してみます

```cmd
ssh -i C:/users/NAME/.ssh/id_ed25519 neko@192.168.100.150
```

パスフレーズを設定している場合は、そのパスフレーズの要求はされるものの、ログインパスワード自体は聞かれることはなくなっているはず

## パスワードでログインできないように

再度 `sshd_config` を編集し、 `PasswordAuthentication no` に、`KbdInteractiveAuthentication no` に変更します

```sh
sudo systemctl reload ssh
```

`exit` してから

```cmd
ssh neko@192.168.100.150
```

もし鍵が `id_ed25519` とかデフォルトの名前の場合は、勝手にその鍵が使われるかもしれませんが、鍵を変えている場合は `Permission denied (public key)` でログインできなくなります。

# メイン PC の config を編集

ssh 接続時に毎度 `-i` で鍵を指定すればログインできるが面倒なので config を書く

メイン PC の `C:/users/NAME/.ssh/config` を編集し

```text
Host neko-pc
  HostName 192.168.100.150
  User neko
  IdentityFile C:/users/NAME/.ssh/id_neko
```

のような指定を記述することで

```cmd
ssh neko-pc
```

だけで

```cmd
ssh -i C:/users/NAME/.ssh/id_neko neko@192.168.100.150
```

をショートカット記述できます

---

現状の初期設定はここまで